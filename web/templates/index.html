<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="title">æŠ¥é”€åŠ©æ‰‹ - æ™ºèƒ½å‘ç¥¨è¯†åˆ«</title>
    <meta name="description" content="ä¸Šä¼ å‘ç¥¨ï¼Œè‡ªåŠ¨è¯†åˆ«åˆ†ç±»ï¼Œä¸‹è½½æ•´ç†ç»“æœå’Œ Excel æŠ¥è¡¨ã€‚">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="page-wrapper">
        <div class="container">
            <header>
                <h1 data-i18n="appName">æŠ¥é”€åŠ©æ‰‹</h1>
                <p class="subtitle" data-i18n="appDesc">ä¸Šä¼ å‘ç¥¨ï¼Œè‡ªåŠ¨è¯†åˆ«åˆ†ç±»ï¼Œç”ŸæˆæŠ¥é”€æŠ¥è¡¨</p>
                <nav class="header-nav">
                    <a href="/settings" class="nav-link">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                        <span data-i18n="settings">è®¾ç½®</span>
                    </a>
                    <button id="lang-toggle" class="lang-toggle" title="Switch Language">
                        <span id="lang-label">EN</span>
                    </button>
                </nav>
            </header>

            {% if not configured %}
            <div class="info-banner">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                <span data-i18n="localMode">å½“å‰ä½¿ç”¨æœ¬åœ° OCR æ¨¡å¼ï¼Œ<a href="/settings">é…ç½® API Key</a> å¯è·å¾—æ›´é«˜è¯†åˆ«å‡†ç¡®ç‡</span>
            </div>
            {% endif %}

            <!-- Main Card -->
            <div class="main-card">

                <!-- Upload Section -->
                <div id="upload-section" class="card-section">
                    <div id="drop-zone" class="drop-zone">
                        <div class="drop-zone-content">
                            <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M4 16v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2"></path>
                                <path d="M12 4v12m0-12L8 8m4-4l4 4"></path>
                            </svg>
                            <p class="drop-text" data-i18n="dropText">æ‹–æ”¾æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹åˆ°æ­¤å¤„</p>
                            <p class="drop-subtext" data-i18n="dropSubtext">æˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é€‰æ‹©</p>
                            <p class="drop-hint" data-i18n="dropHint">æ”¯æŒ JPGã€PNGã€PDF æ ¼å¼</p>
                            <div class="upload-buttons">
                                <button type="button" id="select-files-btn" class="btn btn-outline" data-i18n="selectFiles">é€‰æ‹©æ–‡ä»¶</button>
                                <button type="button" id="select-folder-btn" class="btn btn-outline" data-i18n="selectFolder">é€‰æ‹©æ–‡ä»¶å¤¹</button>
                            </div>
                        </div>
                        <input type="file" id="file-input" multiple accept=".jpg,.jpeg,.png,.bmp,.tiff,.webp,.pdf">
                        <input type="file" id="folder-input" webkitdirectory multiple>
                    </div>

                    <!-- Selected Files -->
                    <div id="file-list" class="file-list hidden">
                        <h3><span data-i18n="selectedFiles">å·²é€‰æ–‡ä»¶</span>ï¼ˆ<span id="file-count">0</span><span data-i18n="filesUnit"> ä¸ª</span>ï¼‰</h3>
                        <ul id="files-ul"></ul>
                        <div class="button-group">
                            <button id="clear-btn" class="btn btn-secondary" data-i18n="clear">æ¸…ç©º</button>
                            <button id="upload-btn" class="btn btn-primary" data-i18n="startProcess">å¼€å§‹å¤„ç†</button>
                        </div>
                    </div>
                </div>

                <!-- Progress Section -->
                <div id="progress-section" class="card-section hidden">
                    <div class="progress-card">
                        <div class="progress-spinner"></div>
                        <h2 data-i18n="processing">æ­£åœ¨å¤„ç†ä¸­</h2>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div id="progress-fill" class="progress-fill"></div>
                            </div>
                            <p id="progress-text" class="progress-text" data-i18n="preparing">å‡†å¤‡ä¸­...</p>
                        </div>
                        <p id="current-file" class="current-file"></p>
                    </div>
                </div>

                <!-- Result Section -->
                <div id="result-section" class="card-section hidden">
                    <div class="result-card">
                        <div class="result-check">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </div>
                        <h2 data-i18n="completed">å¤„ç†å®Œæˆ</h2>
                        <div class="summary">
                            <h3 data-i18n="summary">æŠ¥é”€æ±‡æ€»</h3>
                            <table id="summary-table">
                                <thead>
                                    <tr>
                                        <th data-i18n="category">ç±»åˆ«</th>
                                        <th data-i18n="count">æ•°é‡</th>
                                        <th data-i18n="amount">é‡‘é¢</th>
                                    </tr>
                                </thead>
                                <tbody id="summary-body">
                                </tbody>
                                <tfoot>
                                    <tr class="total-row">
                                        <td data-i18n="total">åˆè®¡</td>
                                        <td id="total-count">-</td>
                                        <td id="total-amount">-</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="button-group">
                            <button id="download-btn" class="btn btn-primary btn-large" data-i18n="downloadResult">ä¸‹è½½æŠ¥é”€ç»“æœï¼ˆZIPï¼‰</button>
                            <button id="restart-btn" class="btn btn-secondary" data-i18n="continueProcess">ç»§ç»­å¤„ç†</button>
                        </div>
                        <p class="privacy-note" data-i18n="privacyNote">æ–‡ä»¶å°†åœ¨ä¸‹è½½åè‡ªåŠ¨æ¸…ç†ï¼Œä¿æŠ¤æ‚¨çš„éšç§</p>
                    </div>
                </div>

                <!-- Error Section -->
                <div id="error-section" class="card-section hidden">
                    <div class="error-card">
                        <h2 data-i18n="errorTitle">å¤„ç†å‡ºé”™</h2>
                        <p id="error-message" class="error-message"></p>
                        <button id="retry-btn" class="btn btn-primary" data-i18n="retry">é‡æ–°å°è¯•</button>
                    </div>
                </div>

            </div><!-- End Main Card -->

        </div>

        <footer>
            <p data-i18n="footerText">AI é©±åŠ¨çš„æ™ºèƒ½å‘ç¥¨è¯†åˆ«ä¸æŠ¥é”€æ•´ç†å·¥å…·</p>
            <div class="footer-links">
                <a href="/settings" data-i18n="settings">è®¾ç½®</a>
                <a href="/privacy" data-i18n="privacy">éšç§æ”¿ç­–</a>
            </div>
        </footer>
    </div>

    <script>
        // ========== i18n ==========
        const i18n = {
            zh: {
                title: 'æŠ¥é”€åŠ©æ‰‹ - æ™ºèƒ½å‘ç¥¨è¯†åˆ«',
                appName: 'æŠ¥é”€åŠ©æ‰‹',
                appDesc: 'ä¸Šä¼ å‘ç¥¨ï¼Œè‡ªåŠ¨è¯†åˆ«åˆ†ç±»ï¼Œç”ŸæˆæŠ¥é”€æŠ¥è¡¨',
                settings: 'è®¾ç½®',
                localMode: 'å½“å‰ä½¿ç”¨æœ¬åœ° OCR æ¨¡å¼ï¼Œ<a href="/settings">é…ç½® API Key</a> å¯è·å¾—æ›´é«˜è¯†åˆ«å‡†ç¡®ç‡',
                dropText: 'æ‹–æ”¾æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹åˆ°æ­¤å¤„',
                dropSubtext: 'æˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é€‰æ‹©',
                dropHint: 'æ”¯æŒ JPGã€PNGã€PDF æ ¼å¼',
                selectFiles: 'é€‰æ‹©æ–‡ä»¶',
                selectFolder: 'é€‰æ‹©æ–‡ä»¶å¤¹',
                selectedFiles: 'å·²é€‰æ–‡ä»¶',
                filesUnit: ' ä¸ª',
                clear: 'æ¸…ç©º',
                startProcess: 'å¼€å§‹å¤„ç†',
                processing: 'æ­£åœ¨å¤„ç†ä¸­',
                preparing: 'å‡†å¤‡ä¸­...',
                uploading: 'ä¸Šä¼ ä¸­...',
                completed: 'å¤„ç†å®Œæˆ',
                summary: 'æŠ¥é”€æ±‡æ€»',
                category: 'ç±»åˆ«',
                count: 'æ•°é‡',
                amount: 'é‡‘é¢',
                total: 'åˆè®¡',
                downloadResult: 'ä¸‹è½½æŠ¥é”€ç»“æœï¼ˆZIPï¼‰',
                downloading: 'ä¸‹è½½ä¸­...',
                downloadDone: 'ä¸‹è½½å®Œæˆ',
                continueProcess: 'ç»§ç»­å¤„ç†',
                privacyNote: 'æ–‡ä»¶å°†åœ¨ä¸‹è½½åè‡ªåŠ¨æ¸…ç†ï¼Œä¿æŠ¤æ‚¨çš„éšç§',
                errorTitle: 'å¤„ç†å‡ºé”™',
                retry: 'é‡æ–°å°è¯•',
                footerText: 'AI é©±åŠ¨çš„æ™ºèƒ½å‘ç¥¨è¯†åˆ«ä¸æŠ¥é”€æ•´ç†å·¥å…·',
                privacy: 'éšç§æ”¿ç­–',
                uploadFailed: 'ä¸Šä¼ å¤±è´¥',
                networkError: 'ç½‘ç»œé”™è¯¯ï¼š',
                statusFailed: 'çŠ¶æ€æŸ¥è¯¢å¤±è´¥',
                processFailed: 'å¤„ç†å¤±è´¥',
                downloadFailed: 'ä¸‹è½½å¤±è´¥ï¼š',
                unknownError: 'æœªçŸ¥é”™è¯¯',
                removeFile: 'ç§»é™¤',
                statusQueued: 'æ’é˜Ÿç­‰å¾…ä¸­...',
                statusProcessing: 'æ­£åœ¨è¯†åˆ«ï¼ˆ{current}/{total}ï¼‰',
                statusOrganizing: 'æ­£åœ¨æ•´ç†åˆ†ç±»...',
                statusReport: 'æ­£åœ¨ç”ŸæˆæŠ¥è¡¨...',
                statusPacking: 'æ­£åœ¨æ‰“åŒ…ä¸‹è½½...',
                unitSheet: ' å¼ ',
                categoryNames: {
                    'æ‰“è½¦ç¥¨': 'æ‰“è½¦ç¥¨',
                    'ç«è½¦é£æœºç¥¨': 'ç«è½¦é£æœºç¥¨',
                    'ä½å®¿è´¹': 'ä½å®¿è´¹',
                    'é¤è´¹': 'é¤è´¹',
                    'å…¶ä»–': 'å…¶ä»–'
                }
            },
            en: {
                title: 'Expense Helper - Smart Invoice Processing',
                appName: 'Expense Helper',
                appDesc: 'Upload invoices, auto-recognize & categorize, generate reports',
                settings: 'Settings',
                localMode: 'Using local OCR mode. <a href="/settings">Configure API Key</a> for better accuracy',
                dropText: 'Drop files or folders here',
                dropSubtext: 'or click below to browse',
                dropHint: 'Supports JPG, PNG, PDF',
                selectFiles: 'Select Files',
                selectFolder: 'Select Folder',
                selectedFiles: 'Selected Files',
                filesUnit: '',
                clear: 'Clear',
                startProcess: 'Start Processing',
                processing: 'Processing...',
                preparing: 'Preparing...',
                uploading: 'Uploading...',
                completed: 'Complete',
                summary: 'Expense Summary',
                category: 'Category',
                count: 'Count',
                amount: 'Amount',
                total: 'Total',
                downloadResult: 'Download Results (ZIP)',
                downloading: 'Downloading...',
                downloadDone: 'Download Complete',
                continueProcess: 'Process More',
                privacyNote: 'Files auto-delete after download for your privacy',
                errorTitle: 'Error',
                retry: 'Try Again',
                footerText: 'AI-Powered Invoice Recognition & Organization',
                privacy: 'Privacy Policy',
                uploadFailed: 'Upload failed',
                networkError: 'Network error: ',
                statusFailed: 'Status check failed',
                processFailed: 'Processing failed',
                downloadFailed: 'Download failed: ',
                unknownError: 'Unknown error',
                removeFile: 'Remove',
                statusQueued: 'Queued...',
                statusProcessing: 'Recognizing ({current}/{total})',
                statusOrganizing: 'Organizing files...',
                statusReport: 'Generating report...',
                statusPacking: 'Packing download...',
                unitSheet: '',
                categoryNames: {
                    'æ‰“è½¦ç¥¨': 'Transportation',
                    'ç«è½¦é£æœºç¥¨': 'Travel',
                    'ä½å®¿è´¹': 'Accommodation',
                    'é¤è´¹': 'Meals',
                    'å…¶ä»–': 'Other'
                }
            }
        };

        let currentLang = localStorage.getItem('lang') || 'zh';

        function t(key) {
            return i18n[currentLang][key] || key;
        }

        function applyLanguage() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                if (i18n[currentLang][key] !== undefined) {
                    if (key === 'localMode') {
                        el.innerHTML = i18n[currentLang][key];
                    } else {
                        el.textContent = i18n[currentLang][key];
                    }
                }
            });
            document.getElementById('lang-label').textContent = currentLang === 'zh' ? 'EN' : 'ä¸­';
            document.documentElement.lang = currentLang === 'zh' ? 'zh-CN' : 'en';
        }

        document.getElementById('lang-toggle').addEventListener('click', () => {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            localStorage.setItem('lang', currentLang);
            applyLanguage();
            // Re-render file list if visible
            if (selectedFiles.length > 0) updateFileList();
            // Re-render result if visible
            if (!resultSection.classList.contains('hidden') && lastResultData) {
                showResult(lastResultData);
            }
        });

        // ========== State ==========
        let selectedFiles = [];
        let currentTaskId = null;
        let pollInterval = null;
        let lastResultData = null;

        // ========== DOM Elements ==========
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const folderInput = document.getElementById('folder-input');
        const selectFilesBtn = document.getElementById('select-files-btn');
        const selectFolderBtn = document.getElementById('select-folder-btn');
        const fileList = document.getElementById('file-list');
        const filesUl = document.getElementById('files-ul');
        const fileCount = document.getElementById('file-count');
        const uploadBtn = document.getElementById('upload-btn');
        const clearBtn = document.getElementById('clear-btn');

        const uploadSection = document.getElementById('upload-section');
        const progressSection = document.getElementById('progress-section');
        const resultSection = document.getElementById('result-section');
        const errorSection = document.getElementById('error-section');

        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const currentFile = document.getElementById('current-file');

        const summaryBody = document.getElementById('summary-body');
        const totalCount = document.getElementById('total-count');
        const totalAmount = document.getElementById('total-amount');
        const downloadBtn = document.getElementById('download-btn');
        const restartBtn = document.getElementById('restart-btn');
        const retryBtn = document.getElementById('retry-btn');
        const errorMessage = document.getElementById('error-message');

        // ========== Drag & Drop ==========
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const items = e.dataTransfer.items;
            if (items && items.length > 0) {
                const files = await getAllFiles(items);
                handleFiles(files);
            } else {
                handleFiles(e.dataTransfer.files);
            }
        });

        dropZone.addEventListener('click', (e) => {
            if (e.target.closest('.upload-buttons')) return;
            if (isDesktopApp()) return;
            fileInput.click();
        });

        async function getAllFiles(items) {
            const files = [];
            async function traverseEntry(entry) {
                if (entry.isFile) {
                    return new Promise((resolve) => {
                        entry.file((file) => { files.push(file); resolve(); });
                    });
                } else if (entry.isDirectory) {
                    const reader = entry.createReader();
                    return new Promise((resolve) => {
                        reader.readEntries(async (entries) => {
                            for (const e of entries) await traverseEntry(e);
                            resolve();
                        });
                    });
                }
            }
            for (const item of items) {
                const entry = item.webkitGetAsEntry ? item.webkitGetAsEntry() : null;
                if (entry) await traverseEntry(entry);
                else if (item.kind === 'file') files.push(item.getAsFile());
            }
            return files;
        }

        function isDesktopApp() {
            return typeof window.pywebview !== 'undefined';
        }

        // ========== Button Events ==========
        selectFilesBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (isDesktopApp()) {
                try {
                    const files = await window.pywebview.api.select_files();
                    handleNativeFiles(files);
                } catch (err) { fileInput.click(); }
            } else { fileInput.click(); }
        });

        selectFolderBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (isDesktopApp()) {
                try {
                    const files = await window.pywebview.api.select_folder();
                    handleNativeFiles(files);
                } catch (err) { folderInput.click(); }
            } else { folderInput.click(); }
        });

        function handleNativeFiles(files) {
            if (!files || files.length === 0) return;
            for (const fileInfo of files) {
                const fileObj = { name: fileInfo.name, size: fileInfo.size, path: fileInfo.path, isNative: true };
                if (!selectedFiles.find(f => f.name === fileObj.name && f.size === fileObj.size)) {
                    selectedFiles.push(fileObj);
                }
            }
            updateFileList();
        }

        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        folderInput.addEventListener('change', (e) => handleFiles(e.target.files));

        function handleFiles(files) {
            const allowedTypes = ['image/jpeg', 'image/png', 'image/bmp', 'image/tiff', 'image/webp', 'application/pdf'];
            const allowedExts = ['.jpg', '.jpeg', '.png', '.bmp', '.tiff', '.webp', '.pdf'];
            for (const file of files) {
                const ext = '.' + file.name.split('.').pop().toLowerCase();
                if (allowedTypes.includes(file.type) || allowedExts.includes(ext)) {
                    if (!selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
                        selectedFiles.push(file);
                    }
                }
            }
            updateFileList();
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function updateFileList() {
            if (selectedFiles.length === 0) { fileList.classList.add('hidden'); return; }
            fileList.classList.remove('hidden');
            fileCount.textContent = selectedFiles.length;
            filesUl.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const li = document.createElement('li');
                const ext = file.name.split('.').pop().toLowerCase();
                const icon = ext === 'pdf' ? 'ğŸ“„' : 'ğŸ–¼';
                li.innerHTML = `
                    <span class="file-icon">${icon}</span>
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${formatSize(file.size)}</span>
                    <button class="remove-btn" data-index="${index}" title="${t('removeFile')}">&times;</button>
                `;
                filesUl.appendChild(li);
            });
            filesUl.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    selectedFiles.splice(parseInt(e.target.dataset.index), 1);
                    updateFileList();
                });
            });
        }

        clearBtn.addEventListener('click', () => {
            selectedFiles = [];
            fileInput.value = '';
            updateFileList();
        });

        // ========== Upload ==========
        uploadBtn.addEventListener('click', async () => {
            if (selectedFiles.length === 0) return;
            try {
                showSection('progress');
                progressFill.style.width = '0%';
                progressText.textContent = t('uploading');

                let response;
                const hasNativeFiles = selectedFiles.some(f => f.isNative && f.path);

                if (hasNativeFiles) {
                    const paths = selectedFiles.filter(f => f.path).map(f => f.path);
                    response = await fetch('/upload', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ paths: paths })
                    });
                } else {
                    const formData = new FormData();
                    selectedFiles.forEach(file => formData.append('files[]', file));
                    response = await fetch('/upload', { method: 'POST', body: formData });
                }

                const data = await response.json();
                if (response.ok) {
                    currentTaskId = data.task_id;
                    startPolling();
                } else {
                    showError(data.error || t('uploadFailed'));
                }
            } catch (error) {
                showError(t('networkError') + error.message);
            }
        });

        // ========== Polling ==========
        function startPolling() {
            pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/status/${currentTaskId}`);
                    const data = await response.json();
                    if (!response.ok) { clearInterval(pollInterval); showError(data.error || t('statusFailed')); return; }
                    updateProgress(data);
                    if (data.status === 'completed') { clearInterval(pollInterval); showResult(data); }
                    else if (data.status === 'error') { clearInterval(pollInterval); showError(data.error || t('processFailed')); }
                } catch (error) { clearInterval(pollInterval); showError(t('networkError') + error.message); }
            }, 1000);
        }

        function updateProgress(data) {
            const statusMap = {
                'queued': t('statusQueued'),
                'processing': t('statusProcessing').replace('{current}', data.current).replace('{total}', data.total),
                'organizing': t('statusOrganizing'),
                'generating_report': t('statusReport'),
                'packing': t('statusPacking')
            };
            progressText.textContent = statusMap[data.status] || data.status;
            if (data.total > 0) {
                progressFill.style.width = Math.round((data.current / data.total) * 100) + '%';
            }
            if (data.current_file) currentFile.textContent = data.current_file;
        }

        // ========== Result ==========
        function showResult(data) {
            lastResultData = data;
            showSection('result');
            summaryBody.innerHTML = '';
            let totalInvoices = 0, totalSum = 0;
            const categories = ['æ‰“è½¦ç¥¨', 'ç«è½¦é£æœºç¥¨', 'ä½å®¿è´¹', 'é¤è´¹', 'å…¶ä»–'];
            const catNames = t('categoryNames');

            categories.forEach(cat => {
                const info = data.summary[cat];
                if (info && info.count > 0) {
                    const tr = document.createElement('tr');
                    const displayName = (typeof catNames === 'object' && catNames[cat]) || cat;
                    const unit = t('unitSheet');
                    tr.innerHTML = `
                        <td>${displayName}</td>
                        <td>${info.count}${unit}</td>
                        <td>Â¥${info.amount.toFixed(2)}</td>
                    `;
                    summaryBody.appendChild(tr);
                    totalInvoices += info.count;
                    totalSum += info.amount;
                }
            });

            totalCount.textContent = totalInvoices + t('unitSheet');
            totalAmount.textContent = 'Â¥' + totalSum.toFixed(2);
        }

        // ========== Download ==========
        downloadBtn.addEventListener('click', async () => {
            if (!currentTaskId) return;
            if (isDesktopApp()) {
                try {
                    downloadBtn.disabled = true;
                    downloadBtn.textContent = t('downloading');
                    const result = await window.pywebview.api.download_file(
                        `/download/${currentTaskId}`,
                        `æŠ¥é”€ç»“æœ_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.zip`
                    );
                    if (result.success) {
                        downloadBtn.textContent = t('downloadDone');
                        setTimeout(() => { downloadBtn.disabled = false; downloadBtn.textContent = t('downloadResult'); }, 2000);
                    } else if (!result.cancelled) {
                        alert(t('downloadFailed') + (result.error || t('unknownError')));
                        downloadBtn.disabled = false;
                        downloadBtn.textContent = t('downloadResult');
                    } else {
                        downloadBtn.disabled = false;
                        downloadBtn.textContent = t('downloadResult');
                    }
                } catch (err) {
                    alert(t('downloadFailed') + err.message);
                    downloadBtn.disabled = false;
                    downloadBtn.textContent = t('downloadResult');
                }
            } else {
                window.location.href = `/download/${currentTaskId}`;
            }
        });

        // ========== Reset ==========
        restartBtn.addEventListener('click', reset);
        retryBtn.addEventListener('click', reset);

        function reset() {
            selectedFiles = [];
            currentTaskId = null;
            lastResultData = null;
            fileInput.value = '';
            updateFileList();
            showSection('upload');
        }

        function showSection(name) {
            uploadSection.classList.add('hidden');
            progressSection.classList.add('hidden');
            resultSection.classList.add('hidden');
            errorSection.classList.add('hidden');
            if (name === 'upload') uploadSection.classList.remove('hidden');
            if (name === 'progress') progressSection.classList.remove('hidden');
            if (name === 'result') resultSection.classList.remove('hidden');
            if (name === 'error') errorSection.classList.remove('hidden');
        }

        function showError(message) {
            errorMessage.textContent = message;
            showSection('error');
        }

        // Init language
        applyLanguage();
    </script>
</body>
</html>
